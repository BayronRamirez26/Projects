@model List<IntranetFM.Modelos.MovimientodeActivo>
@{
    ViewData["Title"] = "Historial de Movimientos";
}

<div class="container mt-4">
    <h2>Historial de Movimientos</h2>

    <!-- Búsqueda -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por activo, ubicación, responsable..." />
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search"></i> Buscar
                </button>
                <button class="btn btn-outline-danger" type="button" id="clearSearch" style="display: none;">
                    <i class="bi bi-x-circle"></i> Limpiar
                </button>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group">
                <button class="btn btn-outline-secondary" id="prevPage" disabled>
                    <i class="bi bi-chevron-left"></i> Anterior
                </button>
                <button class="btn btn-outline-secondary" id="nextPage">
                    Siguiente <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead style="background-color: #00C0F3; color: white;">
                <tr>
                    <th>Activo</th>
                    <th>Movimiento</th>
                    <th>Ubicación</th>
                    <th>Responsable</th>
                    <th>Fecha</th>
                    <th>Documento</th>
                </tr>
            </thead>
            <tbody id="movimientosTableBody">
                @if (ViewBag.ListaMovimientos != null)
                {
                    foreach (var mov in ViewBag.ListaMovimientos)
                    {
                        <tr>
                            <td>@mov._idActivo._descripcion</td>
                            <td>@mov._idtipomovimiento</td>
                            <td>@mov._idUnidaddestino</td>
                            <td>@mov._idusuario._persona._nombre @mov._idusuario._persona._apellido1</td>
                            <td>@mov._fechamovimiento</td>
                            <td>@mov._documento</td>
                        </tr>
                    }
                }
                <!-- JS se encarga de llenar -->
            </tbody>
        </table>
    </div>

    <!-- Sin resultados -->
    <div id="noResults" class="alert alert-warning mt-3" style="display: none;">
        No se encontraron movimientos.
    </div>
</div>

@section Scripts {
    <script>
        let allMovimientos = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 10;

        document.addEventListener('DOMContentLoaded', function () {
            allMovimientos = @Html.Raw(Json.Serialize(Model)) || [];

            allMovimientos = allMovimientos.map(mov => ({
                activo: mov._idActivo._descripcion || 'Sin descripción',
                tipo: mov._idtipomovimiento || '',
                ubicacion: mov._idUnidaddestino || 'N/A',
                responsable: mov._idusuario._persona._nombre + " " + mov._idusuario._persona._apellido1 || 'No asignado',
                fecha: mov._fechamovimiento ? new Date(mov._fechamovimiento).toLocaleDateString() : '',
                documento: mov._documento || ''
            }));

            filteredData = [...allMovimientos];
            updateTable();
            setupListeners();
        });

        function setupListeners() {
            document.getElementById('searchButton').addEventListener('click', filterData);
            document.getElementById('searchInput').addEventListener('keyup', function (e) {
                if (e.key === 'Enter') filterData();
            });
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));
        }

        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allMovimientos.filter(mov =>
                mov.activo.toLowerCase().includes(search) ||
                mov.ubicacion.toLowerCase().includes(search) ||
                mov.tipo.toLowerCase().includes(search) ||
                mov.responsable.toLowerCase().includes(search)
            );

            currentPage = 1;
            updateTable();
            document.getElementById('clearSearch').style.display = search ? 'block' : 'none';
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filteredData = [...allMovimientos];
            currentPage = 1;
            updateTable();
            document.getElementById('clearSearch').style.display = 'none';
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const newPage = currentPage + direction;

            if (newPage > 0 && newPage <= totalPages) {
                currentPage = newPage;
                updateTable();
            }
        }

        function updateTable() {
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const dataToShow = filteredData.slice(startIndex, endIndex);
            const tbody = document.getElementById('movimientosTableBody');

            tbody.innerHTML = '';

            if (dataToShow.length === 0) {
                document.getElementById('noResults').style.display = 'block';
            } else {
                document.getElementById('noResults').style.display = 'none';

                dataToShow.forEach(mov => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                            <td>${mov.activo}</td>
                            <td>${mov.tipo}</td>
                            <td>${mov.ubicacion}</td>
                            <td>${mov.responsable}</td>
                            <td>${mov.fecha}</td>
                            <td>${mov.documento}</td>
                        `;
                    tbody.appendChild(row);
                });
            }

            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= Math.ceil(filteredData.length / rowsPerPage);
        }
    </script>
}